<html>
<head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="css/base.css" rel="stylesheet" >
    <script src="https://code.jquery.com/jquery.min.js"></script>

    <script type="text/javascript">

        // シート列定義
        var COL = {
            NUM : 0,
            TITLE : 1,
            ICON : 2,
            STREET : 3,
            NEXT : 4,
            ODO : 5,
            SIGNAL : 6,
            MEMO : 7,
        };

        // オリジナルデータ
        var sheetData;
        // 整形後データ
        var arrayData;

        // ロード時処理
        window.onload = function () {
            //デフォルトのURLを挿入
            var defUrl = "https://docs.google.com/spreadsheets/d/1Eavr0q9ijsz0ZIsI9HoK0L_6Dl5w38-W0oyiEDe00wU/edit#gid=0";
            $("#sheetUrl").val(defUrl);
        };

        // loadボタンクリックイベント
        $(document).on('click', "#loadButton", function () {

            // 入力されたURLからKeyを取得
            var split = $("#sheetUrl").val().split("/");
            if (split.length < 5) {
                return false;
            }
            var sheetKey = split[5];

            // APIのURLを生成
            var requestUrl = "https://spreadsheets.google.com/feeds/cells/" + sheetKey + "/od6/public/values?alt=json";

            // SpreadSheetからシート情報を取得して格納
            $.ajax({
                type: 'GET',
                url: requestUrl,
                dataType: 'jsonp',
                cache: false,
                success: function (data) {
                    // 実データ部分を取得
                    sheetData = data.feed.entry;
                    // データ整形
                    changeData();
                    // DOMに展開
                    renderForm();
                    // CSS適用
                    applyCss();
                },
                error: function () {
                    alert('error');
                }
            });
        });

        // データを多次元配列化
        function changeData() {
            arrayData = [];
            for (var i = 0; i < sheetData.length; i++) {
                var col = sheetData[i].gs$cell.col;
                var row = sheetData[i].gs$cell.row;
                var val = sheetData[i].gs$cell.$t;
                if (col == 1) {
                    arrayData.push([]);
                    arrayData[row - 1] = [];
                }
                arrayData[row - 1].push(val);
            }
            console.log(arrayData);
        }

        // 出力
        function renderForm() {

            //TODO
            //次にExcelで出したい形でレイアウトする！
            //IMGタグに変更！
            //信号フラグは重ねる！
            //Enumを使ってTRごとに書いていくようにすることでデータとレイアウトを切り離す！
            //その通りに配置する!

            // 表示初期化
            var selector = "#result";
            $(selector).empty();

            for (var row = 0; row < arrayData.length; row++) {
                // ヘッダ行は表示しない
                if (row==0){ continue; }

                var rowData = arrayData[row];
                var addHtml = "";

                // TBODY, TRを追加
                addHtml +="<tbody>";

                // ------------------------------
                // 1行目
                addHtml +="<tr class='tr_1'>";

                //アイコン列
                addHtml +="<td rowspan='2' class='"+arrayData[0][COL.ICON]+" " + rowData[COL.ICON]+"'></td>";
                //距離列
                addHtml +="<td class='"+arrayData[0][COL.ODO]+"'><span class='bignum'>" + rowData[COL.ODO]+"</span> km</td>"
                //タイトル
                addHtml +="<td class='"+arrayData[0][COL.TITLE]+"'>" + rowData[COL.TITLE]+"</td>"
                //道路名
                addHtml +="<td class='"+arrayData[0][COL.STREET]+"'>" + rowData[COL.STREET]+"</td>"
                //次のポイントまでの距離
                addHtml +="<td class='"+arrayData[0][COL.NEXT]+"'>next / <span class='bignum'>" + rowData[COL.NEXT]+"</span>km</td>"

                addHtml +="</tr>";

                // ------------------------------
                // 2行目
                addHtml +="<tr class='tr_2'>";
                // メモ
                addHtml +="<td colspan='4' class='"+arrayData[0][COL.MEMO]+"'>" + rowData[COL.MEMO]+"</td>"
                addHtml +="</tr>";

                addHtml +="</tbody>";

                // 出力
                $(selector).append(addHtml);
            }
        }

        // 表示調整
        function applyCss(){

            //タイトル・数値巨大化
            $("#result tbody .distance").addClass("bignum");
            $("#result tbody .total").addClass("bignum");

            // 消去
            //$("#result tbody .distance").empty();


        }

    </script>
</head>

<body>
<div>
    <div>
        <table class="table" id="result">
            <tbody></tbody>
        </table>
    </div>

    <div>
        <table class="table" id="testhoge">

            <tbody>
            <tr class="tr_1">
                <td class="icon checkpoint" rowspan="2" width="4em"></td>
                <td class="odo"><span class="bignum">185.4</span>km</td>
                <td class="title">明神前交差点</td>
                <td class="street">八ヶ岳Eライン</td>
                <td class="next">次<span class="bignum">3.7</span>km</td>
            </tr>
            <tr class="tr_2">
                <td class="memo" colspan="4">
                    補給、買い出し。Garmin、ナビの設定など確認。413号線で道志みちで1000m登る。
                </td>
            </tr>
            </tbody>

        </table>
    </div>

    <div>
    <input type="text" class=”form-control” id="sheetUrl" value="">
    <input type="button" class="btn btn-primary" id="loadButton" value="load">
    </div>

</div>
</body>

</html>


